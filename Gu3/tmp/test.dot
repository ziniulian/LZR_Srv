<!DOCTYPE html>
<html>
	<head>
		<title>测试</title>
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, minimum-scale=1.0" />
		<meta charset="utf-8" />
		<link rel="stylesheet" href="/base.css">

		<script type="text/javascript" src="/myLib/LZR.js"></script>

		<style type="text/css">
			td, tr {
				text-align: center;
			}
			.txt {
				padding-left: 0.5rem;
				width: 9rem;
			}
			.txtTim {
				width: 9rem;
			}
			.txtS {
				margin-left: 0.5rem;
				width: 3rem;
			}
		</style>
	</head>

	<body>
		<div id="boso" class="boso">
			<div class="logo">
				<form id="qryFmDom" action="{{=it.tmpo.url.base}}/" method="post" target="_self">
					<input id="inDom" name="id" class="txt" type="text" placeholder="请输入代码"
						list="indtDom" value="{{=it.pop ? it.pop.id : ''}}"
						onfocus="this.select();"
						onchange="dco.reset();"/>
					<datalist id="indtDom">
						{{~it.ids:o:i}}
							<option value="{{=o.id}}{{=o.nam}}{{=o.abb || ''}}"/>
								{{? it.pop && o.id === it.pop.id}}
									<script type="text/javascript">
										inDom.value = "{{=o.id}}{{=o.nam}}";
									</script>
								{{?}}
						{{~}}
					</datalist>
					<input name="days" type="date" class="txtTim" value="{{=it.pop ? it.pop.days : ''}}" onchange="dco.reset();"/>
					<input name="daye" type="date" class="txtTim" value="{{=it.pop ? it.pop.daye : ''}}" onchange="dco.reset();"/>
					<input id="pcDom" type="text" class="txtS" value="20" placeholder="价周期" onchange="dco.hdDat();"/>
					<input id="vcDom" type="text" class="txtS" value="10" placeholder="量周期" onchange="dco.hdDat();"/>
					<input id="syDom" type="text" class="txtS" value="50" placeholder="止盈" onchange="dco.hdDat();"/>
					<input id="ssDom" type="text" class="txtS" value="15" placeholder="止损" onchange="dco.hdDat();"/>
					<input id="dayDom" type="text" class="txtS" value="200" placeholder="天数" onchange="dco.hdDat();"/>
				</form>
				<a class="logohome" target="_blank" href="/"></a>
			</div>
			<div>
				<table>
					<tbody>
						<tr>
							<th>赢</th>
							<th>输</th>
							<th>总计</th>
							<th>成功率</th>
						</tr>
					</tbody>
					<tbody>
						<tr>
							<td id="ytimDom">0</td>
							<td id="stimDom">0</td>
							<td id="ztimDom">0</td>
							<td id="ctDom">0</td>
						</tr>
					</tbody>
				</table>
				<br/>
				<table>
					<tbody>
						<tr>
							<th>时间</th>
							<th>持有天数</th>
							<th>结果</th>
						</tr>
					</tbody>
					<tbody id="tDom"></tbody>
				</table>
			</div>
		</div>
	</body>

	<script type="text/javascript">
/*
	代码
	时间范围
	价格周期（p,pc,pl,ph）
	价格相对于均线的范围
	价格相对于最低点的范围
	量周期（v,vc,vl,vh）
	量相对于最低点的范围
	量相对于最高点的范围
	量相对于均线的范围
	止盈位
	止损位
*/
		LZR.load([
			"LZR.Base.Time"
		]);

		var dco = {
			{{?it.pop}}
				sr: {{=it.tmpo.tls.utJson.toJson(it.comDbSrvReturn)}},
			{{?}}
			utTim: LZR.getSingleton(LZR.Base.Time),

			init: function () {
				{{?it.pop}}
					dco.hdDat();
				{{?}}
			},

			hdDat: function () {
				var i, j, o, t, p, r;
				r = [];
				p = dco.getPro();
				tDom.innerHTML = "";

				for (i = p.p; i < dco.sr.length; i ++) {
					o = {
						s: dco.sr[i],
						h: 0,
						l: 0,
						r: 0,
						p: 0,
						pc: 0,
						pvc: 0,
						ph: 0,
						pl: 0,
						v: 0,
						vc: 0,
						vh: 0,
						vl: 0
					};
					for (j = i - p.p; j < i; j ++) {
						t = dco.sr[j];
						if (o.p) {
							o.pc += t.t;
							o.pvc += t.v;
							if (o.ph < t.h) {
								o.ph = t.h;
							}
							if (o.pl > t.l) {
								o.pl = t.l;
							}
						} else {
							o.p = o.s.c;
							o.pc = t.t;
							o.pvc = t.v;
							o.ph = t.h;
							o.pl = t.l;
						}
					}

					o.v = 0;
					for (j = i - p.v; j < i; j ++) {
						t = dco.sr[j];
						if (o.v) {
							o.vc += t.v;
							if (o.vh < t.v) {
								o.vh = t.v;
							} else if (o.vl > t.v) {
								o.vl = t.v;
							}
						} else {
							o.v = o.s.v;
							o.vc = t.v;
							o.vh = t.v;
							o.vl = t.v;
						}
					}

					o.pc /= o.pvc;
					o.vc /= p.v;
					if (dco.match(o)) {
						o.h = o.p * p.h;
						o.l = o.p * p.l;
						o.tim = this.utTim.formatUTC(o.s.tim, 1, "date2");
						for (j = 1; j < p.d; j ++) {
							t = dco.sr[i + j];
							if (t) {
								if (t.h > o.h) {
									o.t = j;
									o.r = 1;
									break;
								}
								if (t.l < o.l) {
									o.t = j;
									o.r = 2;
									break;
								}
							} else {
								break;
							}
						}
						if (!o.t) {
							o.t = j;
							o.r = 2;
						}
						r.push(o);
					}
				}

				j = 0;
				for (i = 0; i < r.length; i ++) {
					dco.crtR(r[i]);
					if (r[i].r === 1) {
						j ++;
					}
				}
				ytimDom.innerHTML = j;
				stimDom.innerHTML = r.length - j;
				ztimDom.innerHTML = r.length;
				if (r.length) {
					ctDom.innerHTML = (j / r.length * 100).toFixed(2);
				} else {
					ctDom.innerHTML = 0;
				}
			},

			match: function (o) {
				if (
					o.p < o.pc * 1.015 &&
					o.p > o.pc * 0.985 &&
					o.v < o.vl * 1.1 &&
					(o.p - o.pl) / (o.ph - o.pl) < 0.35
				) {
					return true;
				}
				return false;
			},

			getPro: function () {
				var o = {
					p: pcDom.value - 0,
					v: vcDom.value - 0,
					d: dayDom.value - 0,
					h: syDom.value / 100 + 1,
					l: ssDom.value / -100 + 1
				};
				return o;
			},

			crtR: function (o) {
				var r, d;
				r = document.createElement("tr");
				d = document.createElement("td");
				d.innerHTML = o.tim;
				r.appendChild(d);
				d = document.createElement("td");
				d.innerHTML = o.t;
				r.appendChild(d);
				d = document.createElement("td");
				d.innerHTML = (o.r === 1) ? "赢" : "输";
				r.appendChild(d);
				tDom.appendChild(r);
			},

			reset: function () {
				inDom.value = inDom.value.substr(0, 6);
				qryFmDom.submit();
			}
		};

		document.body.onload = dco.init;
	</script>
</html>
