<!DOCTYPE html>
<html>
	<head>
		<title>T+0测试</title>
		{{#def.meta}}

		<script type="text/javascript" src="/comLib/echarts.js"></script>
		<script type="text/javascript" src="/myLib/LZR.js"></script>

		<style type="text/css">
		</style>
	</head>

	<body>
		<div id="boso" class="boso">
			<div class="logo">
				<a id="barDom" href="javascript: dco.run();">停止</a>
				<a class="logohome" target="_blank" href="/"></a>
			</div>
			<table>
				<tbody id="tDom">
				</tbody>
			</table>
		</div>
	</body>

	<script type="text/javascript">
		LZR.load([
			"LZR.HTML.Base.Ajax"
		]);

		var dco = {
			dat: [],
			t: {	/*临时变量*/
				f: 0
			},
			size: 0,
			bar: false,
			ajx: new LZR.HTML.Base.Ajax().ajax,
			utJson: LZR.getSingleton(LZR.Base.Json),
			url: "http://95.push2.eastmoney.com/api/qt/stock/sse?fltt=2&fields=f43,f170,f47,f48,f49,f50,f137&secid=0.000333",

			init: function () {
				var n, t = {};	/*临时变量*/
				dco.ajx.onreadystatechange = dco.hdDat;
				dco.start();
			},

			hdDat: function (e) {
				var s = e.target.responseText;
				if (s.length) {
					s = s.substr(dco.size);
					dco.size += s.length;
					var o = dco.utJson.toObj(s.substr(5));
					if (o.data) {
						o = o.data;
						var n, t = {
							tim: Date.now(),
							p: o.f43 ? o.f43 : dco.t.p,
							f: o.f170 ? o.f170 : dco.t.f,
							v: o.f47 ? o.f47 : dco.t.v,
							e: o.f48 ? o.f48 : dco.t.e,
							w: o.f49 ? o.f49 : dco.t.w,
							b: o.f50 ? o.f50 : dco.t.b,
							z: o.f137 ? o.f137 : dco.t.z,
							wb: dco.t.wb || 0,
							vb: dco.t.vb || 0,
							zb: dco.t.zb || 0
						};
						if (o.f49 || o.f47) {
							/*内外盘比例*/
							n = t.v - t.w;
							if (n > t.w) {
								if (t.w) {
									t.wb = (t.w - n) / t.w;
								} else {
									t.wb = -1
								}
							} else {
								if (n) {
									t.wb = (t.w - n) / n;
								} else {
									t.wb = 1
								}
							}
							t.wb *= 10;
						}
						if (o.f50) {
							/*量比*/
							if (t.b < 1) {
								t.vb = (1 / t.b) - 1;
							} else {
								t.vb = t.b - 1;
							}
							if (t.vb > 10) {
								t.vb = 10;
							} else if (t.vb < -10) {
								t.vb = -10;
							}
						}
						if (t.e && (o.f137 || o.f48)) {
							/*主力净额*/
							t.zb = t.z / t.e * 10;
						}
/*console.log(t);*/
						dco.t = t;
						dco.dat.push(t);
						dco.flush(t);
					}
				}
			},

			start: function () {
				dco.size = 0;
				dco.ajx.open("GET", dco.url, true);
				dco.ajx.send(null);
				dco.bar = true;
			},

			stop: function () {
				dco.ajx.abort();
				dco.bar = false;
			},

			run: function () {
				if (dco.bar) {
					dco.stop();
					barDom.innerHTML = "开始";
				} else {
					dco.start();
					barDom.innerHTML = "停止";
				}
			},

			flush: function (t) {
				var r = document.createElement("tr");
				var d = document.createElement("td");
				d.innerHTML = t.f.toFixed(2);
				r.appendChild(d);

				d = document.createElement("td");
				d.innerHTML = t.vb.toFixed(2);
				r.appendChild(d);

				d = document.createElement("td");
				d.innerHTML = t.wb.toFixed(2);
				r.appendChild(d);

				d = document.createElement("td");
				d.innerHTML = t.zb.toFixed(2);
				r.appendChild(d);
				tDom.appendChild(r);
			}
		};

		dco.init();
	</script>
</html>
