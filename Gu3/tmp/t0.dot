<!DOCTYPE html>
<html>
	<head>
		<title>T+0</title>
		{{#def.meta}}

		<script type="text/javascript" src="/comLib/echarts.js"></script>
		<script type="text/javascript" src="/myLib/LZR.js"></script>

		<style type="text/css">
			.boso {
				width: 100%;
				height: 100%;
			}
			.chart {
				display: inline-block;
				width: 80%;
				height: 100%;
			}
			.list {
				display: inline-block;
				width: 20%;
				height: 100%;
				overflow-y: auto;
				overflow-x: hidden;
				font-size: 0.7rem;
			}
			.scd {
				background-color: #0FF;
			}
			.out {
				height: 74%;
			}
		</style>
	</head>

	<body>
		<div id="boso" class="boso">
			<div class="logo">
				&nbsp; &nbsp; <input id="sidDom" type="text" placeholder="请输入代码，并按回车键" onchange="dco.reset();"></input>
				&nbsp; &nbsp; <a id="barDom" href="javascript: dco.run();">开始</a>
				&nbsp; &nbsp; <a href="javascript: dco.sav();">保存</a>
				<a class="logohome" target="_blank" href="/"></a>
			</div>

			<div class="out">
				<div id="chartDom" class="chart"></div>
				<div id="listDom" class="list"><table><tbody id="tDom"></tbody></table></div>
			</div>
			<div><table>
				<tbody><tr>
					<td id="tpDom">--</td>
					<td id="tvDom">--</td>
					<td id="thDom">--</td>
					<td id="tzDom">--</td>
					<td id="trDom">--</td>
				</tr></tbody>
			</table></div>
		</div>
	</body>

	<script type="text/javascript">
		LZR.load([
			"LZR.Base.Time",
			"LZR.HTML.Base.Ajax"
		]);

		var dco = {
			stu: 0,	/* 状态：1：抓取成交量；2：时间判断；3：准备就绪；4：循环中。*/
			ajx: new LZR.HTML.Base.Ajax(),
			utJson: LZR.getSingleton(LZR.Base.Json),
			utTim: LZR.getSingleton(LZR.Base.Time),
			urlH: "/Gu/qrySinaK/",
			urlK: "/Gu/qrySinaK/s_sh000001,s_sz399001,s_sz131810,",
			urlS: "/Gu/savT0/",
			url: "",
			hr: document.createElement("hr"),
			tp: 0,	/*滚动条位置*/
			tim: 0,	/*当日时间戳*/
			today: "",	/*当天日期*/
			tmoHd: 0,	/*循环句柄*/
			id: "",
			sid: "",
			bdb: {
				p: 0,	/*当前价*/
				c: 0,	/*收盘价*/
				o: 0,	/*开盘价*/
				h: 0,	/*最高价*/
				l: 0,	/*最低价*/
				v: 0,	/*成交量*/
				w: 0,	/*总盘口*/
				m: 0,	/*最大卖五*/
				n: 0,	/*最小买五*/
				v5: 0,	/*近5日平均每日成交量*/
				vps: 0,	/*近5日平均每秒成交量*/
				vv: 0	/*量比值*/
			},
			db: [],	/*图表数据*/
			pt: {},	/*挂单列表*/
			t: undefined,	/*上一时刻的交易数据*/
			chart: undefined,	/*图表*/
			op: {	/*图表属性*/
				tooltip: {
					trigger: "axis"
				},
				grid: {
					left: "5%",
					right: "2%"
				},
				xAxis: {
					boundaryGap : true,
					data: []
				},
				yAxis: {
					scale: true,	/*脱离零轴*/
					splitArea: {
						show: true
					}
				},
				visualMap: {
					type: "piecewise",
					show: false,
					dimension: 0,	/*0:X轴分段 , 1:y轴分段*/
					seriesIndex: 1,
					pieces: [],
					outOfRange: {
						color: "#AAA"
					}
				},
				dataZoom: [
					{
						type: "inside",	/*鼠标数据区缩放拖拽功能*/
					},
					{
						show: true,
						type: "slider"
					}
				],
				color: ["#F0F","#333","#0FF","#00F","#0A0"],
				legend: {
					data: ["价格", "盘口", "量比", "上证", "深证"]
				},
				series: [
					{
						name: "价格",
						type: "line",
						data: []
					},
					{
						name: "盘口",
						type: "line",
						data: []
					},
					{
						name: "量比",
						type: "line",
						data: []
					},
					{
						name: "上证",
						type: "line",
						data: []
					},
					{
						name: "深证",
						type: "line",
						data: []
					},
					{
						name: "T",
						type: "line",
						lineStyle: {
							normal: {
								color: "rgba(0,0,0,0)",
								width: 0
							}
						},
						data: []
					}
				]
			},

			init: function () {
				dco.today = dco.utTim.format(new Date(), "date2");
				dco.ajx.evt.rsp.add(dco.hd);
				dco.tp = Math.floor(listDom.clientHeight / 2);
				dco.tim = dco.utTim.getDayTimestamp();

				/*图表 ， X轴数据*/
				dco.chart = echarts.init(chartDom);
				var i, t, d = dco.utTim.normalize(null, 9);
				d.setMinutes(15);
				dco.ctim = d.valueOf();
				t = dco.ctim;
				for (i = 0; i < 601; i ++) {
					d.setTime(t);
					dco.op.xAxis.data.push(dco.utTim.format(d, "hh:mm:ss"));
					t += 1000;
				}
				t += 300000;
				for (i = 0; i < 7200; i ++) {
					d.setTime(t);
					dco.op.xAxis.data.push(dco.utTim.format(d, "hh:mm:ss"));
					t += 1000;
				}
				t += 5400000;
				for (i = 0; i < 7200; i ++) {
					d.setTime(t);
					dco.op.xAxis.data.push(dco.utTim.format(d, "hh:mm:ss"));
					t += 1000;
				}
				dco.op.series[5].data[15000] = 0;
				dco.chart.setOption(dco.op);
			},

			stop: function (s) {
				dco.stu = s || 0;
				if (dco.tmoHd) {
					clearInterval(dco.tmoHd);
					dco.tmoHd = 0;
				}
				dco.ajx.abort();
				barDom.innerHTML = "开始";

				if (s === 0) {
					/*清空数据*/
					dco.bdb = {m: 0};
					dco.db = [];
					dco.pt = {};
					dco.t = undefined;
					for (var i = 0; i < 5; i ++) {
						dco.op.series[i].data = [];
					}
					dco.chart.setOption(dco.op);

					tDom.innerHTML = "";
					tpDom.innerHTML = "--";
					tvDom.innerHTML = "--";
					thDom.innerHTML = "--";
					tzDom.innerHTML = "--";
					trDom.innerHTML = "--";
					document.title = "T+0";
				}
			},

			run: function () {
				switch (dco.stu) {
					case 3:
						dco.stu = 4;
						dco.tmoHd = setInterval(dco.get, 2500);
						barDom.innerHTML = "停止";
						break;
					case 4:
						dco.stop(3);
						break;
				}
			},

			reset: function () {
				var id= sidDom.value;
				if (id.match(/^\d{6}$/)) {
					dco.stop(0);
					if (id[0] === "6") {
						dco.sid = "sh" + id;
					} else {
						dco.sid = "sz" + id;
					}

					dco.stu = 1;
					dco.id = id;
					dco.url = dco.urlK + dco.sid + "/";
					dco.ajx.asynPost(dco.urlH + dco.sid + "/5/");
				}
				sidDom.value = "";
			},

			hd: function (txt, status) {
				var i, d, o;
				if (txt.length && txt[0] === "{") {
					o = dco.utJson.toObj(txt);
				} else {
					/*dco.stop(3);*/	/*断网纠错*/
					return;
				}

				if (o.ok) {
					switch (dco.stu) {
						case 1:
							dco.bdb.v5 = 0;
							for (i = 0; i < o.dat.length; i ++) {
								dco.bdb.v5 += o.dat[i].volume - 0;
							}
							dco.bdb.vps = Math.round(dco.bdb.v5 / 75000);
							dco.bdb.v5 = dco.bdb.vps * 15000;

							dco.stu = 2;
							dco.get();
							break;
						case 2:
							o = o.dat.split(";");
							d = o[3].split(",");
							if ((d[30] === dco.today)) {
								dco.stu = 3;
								dco.bdb.c = d[2] - 0;
								dco.bdb.w = 0;
								dco.bdb.vv = 0;
								document.title = d[0].substr(d[0].lastIndexOf("\"") + 1);
								dco.run();
							} else {
								console.log("Err：日期错误！");
								dco.stop();
							}
							break;
						case 4:
							o = o.dat.split(";");
							d = o[3].split(",");
							i = dco.cid(d[31]);
							if (!dco.db[i] && (i > -1)) {
								dco.flush(i, d, o[0].split(","), o[1].split(","), o[2].split(","));
							}
							break;
					}
				} else {
					console.log("Err：连接失败！");
					dco.stop();
				}
			},

			/*计算时间id*/
			cid: function (s) {
				var t = s.split(":");
				var i = t[2] - 33300 + t[0] * 3600 + t[1] * 60;
				if (i > 600) {
					if (i > 900) {
						i -= 300;
						if (i > 7800) {
							if (i > 13200) {
								i -= 5400;
								if (i > 15000) {
									if (i < 15300) {
										i = 15000;
									} else {
										i = -1;
									}
								}
							} else {
								i = 7800;
							}
						}
					} else {
						i = 600;
					}
				}
				return i;
			},

			flush: function (i, s, sh, sz, r) {
				var v, j, k, m, n, t = {
					id: i,
					p: s[3] - 0,
					v: s[8] - 0,
					g: [
						[s[29] - 0, s[28] - 0],
						[s[27] - 0, s[26] - 0],
						[s[25] - 0, s[24] - 0],
						[s[23] - 0, s[22] - 0],
						[s[21] - 0, s[20] - 0],
						[s[11] - 0, s[10] - 0],
						[s[13] - 0, s[12] - 0],
						[s[15] - 0, s[14] - 0],
						[s[17] - 0, s[16] - 0],
						[s[19] - 0, s[18] - 0]
					]
				};
				if (dco.t && dco.t.p) {
					dco.pt[dco.t.p].doe.className = "";
				}

				if (t.g[4][0] !== t.g[5][0]) {
					if (!dco.bdb.o) {
						dco.bdb.o = s[1] - 0;
					}
					dco.bdb.p = t.p;
					dco.bdb.h = s[4] - 0;
					dco.bdb.l = s[5] - 0;
					dco.bdb.v = t.v;
					dco.db[i] = [
						Math.round(t.p / dco.bdb.c * 10000 - 10000) / 100,
						t.v - (dco.t ? dco.t.v : 0)
					];

					/*挂单列表*/
					n = 0;
					for (j = 9; j >= 0; j --) {
						if (t.g[j][0]) {
							m = t.g[j][0];
							if (!n) {
								n = m;
								if (!dco.bdb.n || n < dco.bdb.n) {
									dco.bdb.n = n;
								}
							}
							k = (j < 5 ? -1 : 1);	/*状态：（-1：卖，1：买）*/

							v = dco.pt[m];
							if (v) {
								if ((m < dco.t.g[4][0] ? 1 : -1) === k) {
									v[2] = t.g[j][1] - v[0];
									if (v[2] < 0) {
										v[3] = v[2] * k;
									} else {
										v[3] = 0;
									}
								} else {
									v[2] = t.g[j][1] + v[0];
									v[3] = v[0] * k;
								}
								v[0] = t.g[j][1];
								v[1] = k;
								v[4] = 1;
							} else {
								dco.addTd(m, [t.g[j][1], k, t.g[j][1], 0, 1]);	/*量、状态、量差、缺少的量、修改标记*/
							}
						}
					}

					/*本时刻的买五卖五范围*/
					t.m = m;
					t.n = n;
					if (m > dco.bdb.m) {
						dco.bdb.m = m;
					}

					/*补充本次价格范围间的所有挂单数据*/
					k = 0;
					v = 0;
					for (j = t.n; j <= t.m; j += 0.01) {
						j = Math.round(j * 100) / 100;
						if (dco.pt[j]) {
							if (dco.pt[j][4]) {
								dco.pt[j][4] = 0;
							} else {
								dco.pt[j][1] = j < t.g[4][0] ? 1 : -1;
								dco.pt[j][2] = -dco.pt[j][0];
								dco.pt[j][3] = dco.pt[j][0] * (j < dco.t.g[4][0] ? -1 : 1);
								dco.pt[j][0] = 0;
							}
							dco.pt[j].v.innerHTML = dco.pt[j][0] ? Math.floor(dco.pt[j][0] / 100) : "";
							dco.pt[j].m.innerHTML = dco.pt[j][2] ? Math.floor(dco.pt[j][2] / 100) : "";

							if (dco.pt[j][3]) {
								/*盘口数据统计*/
								v += dco.pt[j][3];
								k += Math.abs(dco.pt[j][3]);
							}
						} else {
							dco.addTd(j, [0, (j < t.g[4][0] ? 1 : -1), 0, 0, 0]);
						}
					}

					/*盘口计算*/
					if (dco.t) {
						j = v;
						v = t.v - dco.t.v;
						if (v) {
							if (k > v) {	/*本次挂单缺失的总量 > 本次增加的成交量*/
								if (t.p > dco.t.p) {
									m = t.p;
									n = dco.t.p;
								} else {
									n = t.p;
									m = dco.t.p;
								}

								/*统计上一次成交价和本次成交价之间的盘口盘口数据*/
								var w = 0;
								k = 0;
								for (j = n; j <= m; j += 0.01) {
									j = Math.round(j * 100) / 100;
									w += dco.pt[j][3];
									k += Math.abs(dco.pt[j][3]);
								}

								if (k < v) {	/*若，两次成交量间的缺失总量 < 本次成交总量 ...
												否则，两次成交价间的盘口变化无论是否真实成交，都全部计入总盘口*/
									/*分别向当前价上下两侧的相邻价位搜索，累积盘口数据，直至满足以下任一条件时截止：
										1. 缺失总量 >= 本次总成交量，
										2. 相邻价位的挂单量无缺失*/
									j = (t.p > dco.t.p) ? 0.01 : -0.01;
									while (m || n) {
										if (j > 0 && m) {
											m = Math.round((m + j) * 100) / 100;
											if (dco.pt[m][3]) {
												u = m;
											} else if (dco.pt[m][0]) {
												m = 0;
												u = 0;
											} else {
												u = 0;
											}
										} else if (n) {
											n = Math.round((n + j) * 100) / 100;
											if (dco.pt[n][3]) {
												u = n;
											} else {
												n = 0;
												u = 0;
											}
										}
										if (u) {
											k += Math.abs(dco.pt[u][3]);
											w += dco.pt[u][3];
											if (k > v) {
												j = k - v;
												if (dco.pt[u][3] > 0) {
													w -= j;
												} else {
													w += j;
												}
												break;
											} else if (k === v) {
												break;
											}
										}
										j = -j;
									}
								}
								dco.db[i][2] = w;
							} else {
								dco.db[i][2] = j;
							}
							dco.bdb.w += dco.db[i][2];	/*盘口数据汇总*/
						}

						/*清空上次更新的旧数据信息*/
						if (t.m < dco.t.m) {
							for (j = dco.t.m; j > t.m; j -= 0.01) {
								j = Math.round(j * 100) / 100;
								dco.pt[j][2] = 0;
								dco.pt[j][3] = 0;
								dco.pt[j].m.innerHTML = "";
							}
						}
						if (t.n > dco.t.n) {
							for (j = dco.t.n; j < t.n; j += 0.01) {
								j = Math.round(j * 100) / 100;
								dco.pt[j][2] = 0;
								dco.pt[j][3] = 0;
								dco.pt[j].m.innerHTML = "";
							}
						}
					}

					/*更新图标数据*/
					dco.fillOp(i, dco.op.series[0].data, dco.db[i][0]);
					dco.fillOp(i, dco.op.series[1].data, Math.round(dco.bdb.w / dco.bdb.v5 * 10000) / 100);
					dco.fillOp(i, dco.op.series[3].data, sh[3] - 0);
					dco.fillOp(i, dco.op.series[4].data, sz[3] - 0);

					/*更新页面数据*/
					tpDom.innerHTML = dco.db[i][0];
					thDom.innerHTML = sh[3] + "/" + Math.round(sh[1]);
					tzDom.innerHTML = sz[3] + "/" + Math.round(sz[1]);
					trDom.innerHTML = r[1];

					/*分隔线 + 挂单列表滚动条定位*/
					tDom.insertBefore(dco.hr, dco.pt[t.g[5][0]].doe);
					dco.pt[t.p].doe.className = "scd";
					if (dco.hr.offsetTop > dco.tp) {
						listDom.scrollTo(0, dco.hr.offsetTop - dco.tp);
					} else {
						listDom.scrollTo(0, 0);
					}
				} else if (t.g[5][1]) {
					/*集合竞价*/
					if (i < 300) {
						dco.db[i] = [
							Math.round(t.g[5][0] / dco.bdb.c * 10000 - 10000) / 100,
							t.g[5][1]
						];
						dco.fillOp(i, dco.op.series[0].data, dco.db[i][0]);
						v = 0;
					} else {
						if (dco.t && (dco.t.g[4][0] === dco.t.g[5][0])) {
							v = t.g[5][1] - dco.t.g[5][1];
						} else {
							v = t.g[5][1];
						}
						dco.db[i] = [
							Math.round(t.g[5][0] / dco.bdb.c * 10000 - 10000) / 100,
							v
						];

						/*盘口计算*/
						if (dco.t) {
							if (t.g[5][0] > dco.t.g[5][0]) {
								dco.db[i][2] = t.g[5][1] - dco.t.g[5][1];
							} else if (t.g[5][0] < dco.t.g[5][0]) {
								dco.db[i][2] = dco.t.g[5][1] - t.g[5][1];
							} else {
								dco.db[i][2] = t.g[6][1] - t.g[3][1] - dco.t.g[6][1] + dco.t.g[3][1];
							}
							dco.bdb.w += dco.db[i][2];
						}

						dco.fillOp(i, dco.op.series[0].data, dco.db[i][0]);
						dco.fillOp(i, dco.op.series[1].data, Math.round(dco.bdb.w / dco.bdb.v5 * 10000) / 100);
					}

					tpDom.innerHTML = dco.db[i][0] + "/" + t.g[5][0];
				}

				if (i > 300) {
					/*数据渲染*/
					v = dco.t ? i - dco.t.id : (i + 1);
					dco.bdb.vv += dco.db[i][1] - dco.bdb.vps * v;
					if (dco.t && (dco.db[i][1] / v / dco.bdb.vps) > 2.8) {	/*放量*/
						v = dco.db[i][2] / dco.db[i][1];
						if (v > 0.7) {
							v = "#0F0";
						} else if (v < 0.3) {
							v = "#F00";
						} else {
							v = "#333";
						}
						dco.op.visualMap.pieces.push({gte: i - 1, lte: i + 1, color: v});
					}
					/*v = Math.round(dco.bdb.vv / i / dco.bdb.vps * 1000) / 1000;*/
					v = Math.round(dco.bdb.vv / dco.bdb.v5 * 1000) / 1000;
					dco.fillOp(i, dco.op.series[2].data, v);
					tvDom.innerHTML = v + "/" + Math.floor(t.v / 100);
				}

				dco.chart.setOption(dco.op);
				dco.t = t;
			},

			/*填充图表数据*/
			fillOp: function (i, d, v) {
				if (!isNaN(v)) {
					d[i] = v;
					for (j = i - 1; j >= 0; j --) {
						if (!isNaN(d[j])) {
							v = d[j];
							for (j++; j < i; j ++) {
								d[j] = v;
							}
							break;
						}
					}
				}
			},

			/*获取数据*/
			get: function () {
				if ((dco.stu === 4) || (dco.stu === 2)) {
					dco.ajx.abort();
					dco.ajx.asynPost(dco.url);
				}
			},

			/*挂单列表增加一行*/
			addTd: function (i, o) {
				dco.pt[i] = o;
				o.doe = document.createElement("tr");
				o.p = document.createElement("td");
				o.p.innerHTML = i.toFixed(2);
				o.v = document.createElement("td");
				o.v.innerHTML = o[0] ? Math.floor(o[0] / 100) : "";
				o.m = document.createElement("td");
				o.m.innerHTML = o[2] ? Math.floor(o[2] / 100) : "";
				o.doe.appendChild(o.p);
				o.doe.appendChild(o.v);
				o.doe.appendChild(o.m);

				if (dco.bdb.n < i) {
					do {
						i = Math.round((i - 0.01) * 100) / 100;
					} while (!dco.pt[i]);
					tDom.insertBefore(o.doe, dco.pt[i].doe);
				} else {
					tDom.appendChild(o.doe);
				}
			},

			/*数据保存*/
			sav: function () {
				if (dco.stu && dco.id) {
					dco.stop(3);
					if (!dco.bdb.d) {
						dco.bdb.d = dco.db;
					}
					dco.ajx.asynPost(dco.urlS + dco.id + "/" + dco.tim + "/", dco.bdb);
				}
			}
		};

		dco.init();
	</script>
</html>
